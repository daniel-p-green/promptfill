<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PromptFill Advanced Editor</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 20px;
        background: transparent;
        color: canvastext;
      }

      .layout {
        margin: 0 auto;
        display: grid;
        gap: 12px;
        max-width: 1180px;
      }

      .surface {
        border: 1px solid color-mix(in srgb, canvastext 16%, transparent);
        border-radius: 16px;
        background: color-mix(in srgb, canvas 95%, transparent);
        padding: 14px;
      }

      h1 {
        margin: 0;
        font-size: 20px;
      }

      p {
        margin: 8px 0 0;
        font-size: 13px;
        line-height: 1.5;
      }

      .workspace {
        display: grid;
        gap: 12px;
      }

      @media (min-width: 1040px) {
        .workspace {
          grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
        }
      }

      .panel-title {
        margin: 0;
        font-size: 14px;
        font-weight: 700;
      }

      .muted {
        margin-top: 4px;
        color: color-mix(in srgb, canvastext 66%, transparent);
        font-size: 12px;
      }

      .field {
        display: grid;
        gap: 6px;
      }

      .field + .field {
        margin-top: 10px;
      }

      .field-label {
        font-size: 12px;
        font-weight: 600;
        color: color-mix(in srgb, canvastext 72%, transparent);
      }

      .search-row {
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto;
        gap: 8px;
        align-items: center;
        margin-top: 10px;
      }

      textarea,
      input {
        width: 100%;
        border: 1px solid color-mix(in srgb, canvastext 16%, transparent);
        border-radius: 10px;
        background: color-mix(in srgb, canvas 98%, transparent);
        color: inherit;
        font: inherit;
        padding: 10px 12px;
      }

      textarea {
        min-height: 160px;
        resize: vertical;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .actions.right {
        justify-content: flex-end;
      }

      button {
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, canvastext 20%, transparent);
        font: inherit;
        font-size: 13px;
        font-weight: 600;
        padding: 7px 14px;
        cursor: pointer;
        background: color-mix(in srgb, canvas 94%, transparent);
        color: inherit;
      }

      button.primary {
        border-color: color-mix(in srgb, #10a37f 55%, transparent);
        background: #10a37f;
        color: #fff;
      }

      button.danger {
        border-color: color-mix(in srgb, #b42318 38%, transparent);
        color: color-mix(in srgb, #b42318 84%, canvastext);
      }

      button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      .library-list {
        margin-top: 10px;
        border: 1px solid color-mix(in srgb, canvastext 14%, transparent);
        border-radius: 12px;
        overflow: hidden;
      }

      .section-label {
        margin: 14px 0 0;
        font-size: 12px;
        font-weight: 700;
        color: color-mix(in srgb, canvastext 72%, transparent);
      }

      .library-item {
        width: 100%;
        text-align: left;
        border: 0;
        border-bottom: 1px solid color-mix(in srgb, canvastext 9%, transparent);
        border-radius: 0;
        background: transparent;
        padding: 10px 12px;
        display: grid;
        gap: 3px;
      }

      .library-item:last-child {
        border-bottom: 0;
      }

      .library-item strong {
        font-size: 12px;
      }

      .library-meta {
        font-size: 11px;
        color: color-mix(in srgb, canvastext 60%, transparent);
      }

      .library-item.active {
        background: color-mix(in srgb, #10a37f 14%, canvas);
      }

      .status {
        font-size: 12px;
        color: color-mix(in srgb, canvastext 66%, transparent);
      }

      .rendered {
        white-space: pre-wrap;
        font-size: 12px;
        line-height: 1.5;
        border: 1px solid color-mix(in srgb, canvastext 16%, transparent);
        border-radius: 10px;
        padding: 10px 12px;
        min-height: 112px;
        background: color-mix(in srgb, canvas 98%, transparent);
      }

      .editor-grid {
        display: grid;
        gap: 10px;
      }

      @media (min-width: 1060px) {
        .editor-grid {
          grid-template-columns: minmax(0, 1.15fr) minmax(0, 1fr);
        }
      }

      .hint {
        margin-top: 12px;
        font-size: 12px;
        color: color-mix(in srgb, canvastext 66%, transparent);
      }
    </style>
  </head>
  <body>
    <main class="layout">
      <section class="surface">
        <h1>PromptFill Workspace</h1>
        <p>
          Manage prompts like a living doc: extract structure, edit schema, search your library, and push
          the final result back into conversation.
        </p>
      </section>

      <section class="workspace">
        <article class="surface">
          <h2 class="panel-title">Template Library</h2>
          <p class="muted">Search, open, and manage reusable PromptFill templates.</p>

          <div class="search-row">
            <input
              id="template-search-input"
              type="search"
              placeholder="Search templates"
              aria-label="Search templates"
            />
            <button id="search-templates-button" type="button">Search</button>
          </div>

          <div class="actions" style="margin-top: 8px">
            <button id="list-templates-button" type="button">Refresh</button>
            <button id="suggest-templates-button" type="button">Starter</button>
            <button id="clear-selection-button" type="button">New draft</button>
          </div>

          <div id="template-library" class="library-list" role="list" aria-label="Saved templates"></div>

          <p class="section-label">Version history</p>
          <div class="actions" style="margin-top: 8px">
            <button id="list-versions-button" type="button" disabled>List versions</button>
          </div>
          <div id="version-history" class="library-list" role="list" aria-label="Template version history"></div>
        </article>

        <article class="surface">
          <div class="field">
            <span class="field-label">Template name</span>
            <input id="template-name-input" type="text" placeholder="Weekly status update" />
          </div>

          <div class="actions right" style="margin-top: 10px">
            <button id="save-template-button" class="primary" type="button">Save</button>
            <button id="update-template-button" type="button" disabled>Update</button>
            <button id="delete-template-button" class="danger" type="button" disabled>Delete</button>
          </div>

          <div class="editor-grid" style="margin-top: 12px">
            <label class="field">
              <span class="field-label">Template</span>
              <textarea id="template-input" spellcheck="false" placeholder="Draft template with {{variables}}..."></textarea>
            </label>
            <label class="field">
              <span class="field-label">Values JSON</span>
              <textarea id="values-input" spellcheck="false" placeholder='{"recipient_name":"Alex","tone":"friendly"}'>{}</textarea>
            </label>
          </div>

          <label class="field" style="margin-top: 10px">
            <span class="field-label">Variables JSON</span>
            <textarea id="variables-input" spellcheck="false" placeholder='[{"name":"recipient_name","type":"string","required":true}]'>[]</textarea>
          </label>

          <div class="actions right" style="margin-top: 10px">
            <button id="insert-button" type="button" disabled>Insert into chat</button>
            <button id="render-button" class="primary" type="button">Render prompt</button>
          </div>

          <p id="status" class="status" style="margin-top: 8px">Waiting for extracted fields...</p>
          <pre id="rendered-output" class="rendered" hidden></pre>
          <p class="hint">
            Tip: start extraction inline, then use this workspace to evolve and manage templates without
            breaking conversation flow.
          </p>
        </article>
      </section>
    </main>
    <script type="module">
      const templateNameInput = document.getElementById("template-name-input");
      const templateInput = document.getElementById("template-input");
      const variablesInput = document.getElementById("variables-input");
      const valuesInput = document.getElementById("values-input");
      const templateSearchInput = document.getElementById("template-search-input");
      const templateLibrary = document.getElementById("template-library");

      const searchTemplatesButton = document.getElementById("search-templates-button");
      const listTemplatesButton = document.getElementById("list-templates-button");
      const suggestTemplatesButton = document.getElementById("suggest-templates-button");
      const clearSelectionButton = document.getElementById("clear-selection-button");
      const listVersionsButton = document.getElementById("list-versions-button");
      const saveTemplateButton = document.getElementById("save-template-button");
      const updateTemplateButton = document.getElementById("update-template-button");
      const deleteTemplateButton = document.getElementById("delete-template-button");
      const renderButton = document.getElementById("render-button");
      const insertButton = document.getElementById("insert-button");

      const statusEl = document.getElementById("status");
      const renderedOutput = document.getElementById("rendered-output");
      const versionHistory = document.getElementById("version-history");

      let rpcId = 0;
      const pendingRequests = new Map();
      let activeTemplateId = "";
      let lastLibraryTemplates = [];
      let lastTemplateVersions = [];

      function setStatus(text) {
        statusEl.textContent = text;
      }

      function setActiveTemplateId(id) {
        activeTemplateId = id ? String(id) : "";
        const hasActiveTemplate = Boolean(activeTemplateId);
        updateTemplateButton.disabled = !hasActiveTemplate;
        deleteTemplateButton.disabled = !hasActiveTemplate;
        listVersionsButton.disabled = !hasActiveTemplate;
      }

      function resetWorkspace() {
        setActiveTemplateId("");
        templateNameInput.value = "";
        templateInput.value = "";
        variablesInput.value = "[]";
        valuesInput.value = "{}";
        renderedOutput.hidden = true;
        renderedOutput.textContent = "";
        insertButton.disabled = true;
        lastTemplateVersions = [];
        renderVersionHistory(lastTemplateVersions);
      }

      function parseJsonInput(label, raw, fallback) {
        const trimmed = String(raw ?? "").trim();
        if (!trimmed) return fallback;
        try {
          return JSON.parse(trimmed);
        } catch {
          throw new Error(`${label} must be valid JSON.`);
        }
      }

      function renderTemplateLibrary(templates) {
        lastLibraryTemplates = Array.isArray(templates) ? templates : [];

        if (lastLibraryTemplates.length === 0) {
          templateLibrary.innerHTML = '<div class="library-item" role="listitem">No templates found.</div>';
          return;
        }

        templateLibrary.innerHTML = "";
        for (const template of lastLibraryTemplates) {
          const button = document.createElement("button");
          button.type = "button";
          button.className = `library-item${template.id === activeTemplateId ? " active" : ""}`;
          button.setAttribute("role", "listitem");
          button.dataset.templateId = template.id;
          button.innerHTML = `<strong>${template.name}</strong><span class="library-meta">${template.variable_count ?? 0} fields</span>`;
          button.addEventListener("click", async () => {
            if (template.template && Array.isArray(template.variables)) {
              setActiveTemplateId(template.id ?? "");
              templateNameInput.value = template.name ?? "";
              templateInput.value = template.template ?? "";
              variablesInput.value = JSON.stringify(template.variables ?? [], null, 2);
              valuesInput.value = "{}";
              renderedOutput.hidden = true;
              renderedOutput.textContent = "";
              insertButton.disabled = true;
              setStatus(`Loaded starter template "${template.name}".`);
              renderTemplateLibrary(lastLibraryTemplates);
              return;
            }
            await loadTemplateById(template.id);
          });
          templateLibrary.appendChild(button);
        }
      }

      function formatDate(value) {
        if (!value) return "Unknown time";
        const date = new Date(value);
        if (Number.isNaN(date.valueOf())) return "Unknown time";
        return date.toLocaleString();
      }

      async function restoreTemplateVersion(versionId) {
        if (!activeTemplateId || !versionId) return;
        setStatus("Restoring version...");
        await callTool("restore_template_version", { id: activeTemplateId, version_id: versionId });
        await loadTemplateById(activeTemplateId);
        await loadTemplateVersions();
        setStatus("Template restored.");
      }

      function renderVersionHistory(versions) {
        lastTemplateVersions = Array.isArray(versions) ? versions : [];

        if (!activeTemplateId) {
          versionHistory.innerHTML =
            '<div class="library-item" role="listitem">Select a template to view version history.</div>';
          return;
        }

        if (lastTemplateVersions.length === 0) {
          versionHistory.innerHTML = '<div class="library-item" role="listitem">No versions found yet.</div>';
          return;
        }

        versionHistory.innerHTML = "";
        for (const version of lastTemplateVersions) {
          const button = document.createElement("button");
          button.type = "button";
          button.className = "library-item";
          button.setAttribute("role", "listitem");
          button.dataset.versionId = version.version_id;
          button.innerHTML = `<strong>v${version.version_number ?? "?"}</strong><span class="library-meta">${formatDate(
            version.snapshot_at
          )}</span>`;
          button.addEventListener("click", () => {
            restoreTemplateVersion(version.version_id).catch((error) => {
              console.error("restore_template_version failed", error);
              setStatus("Could not restore that version.");
            });
          });
          versionHistory.appendChild(button);
        }
      }

      function setRenderedPrompt(promptText, missingRequired = []) {
        renderedOutput.hidden = false;
        renderedOutput.textContent = promptText ?? "";

        if (Array.isArray(missingRequired) && missingRequired.length > 0) {
          insertButton.disabled = true;
          setStatus(`Missing required: ${missingRequired.join(", ")}`);
          return;
        }

        insertButton.disabled = !promptText;
        setStatus(promptText ? "Rendered prompt ready." : "Render a prompt to continue.");
      }

      function applyToolResult(toolResult) {
        const content = toolResult?.structuredContent;
        if (!content || typeof content !== "object") return;

        if (content.kind === "extraction") {
          templateInput.value = String(content.template ?? "");
          variablesInput.value = JSON.stringify(content.variables ?? [], null, 2);
          valuesInput.value = "{}";
          if (!templateNameInput.value.trim()) {
            templateNameInput.value = "New PromptFill Template";
          }
          renderedOutput.hidden = true;
          renderedOutput.textContent = "";
          insertButton.disabled = true;
          setStatus(`Loaded extraction with ${content.summary?.variable_count ?? 0} field(s).`);
          return;
        }

        if (content.kind === "render") {
          setRenderedPrompt(content.rendered_prompt ?? "", content.missing_required ?? []);
          return;
        }

        if (content.kind === "list" || content.kind === "search" || content.kind === "suggest") {
          renderTemplateLibrary(content.templates ?? []);
          setStatus(
            content.templates?.length
              ? `Library ready with ${content.templates.length} template${content.templates.length === 1 ? "" : "s"}.`
              : "No templates found."
          );
          return;
        }

        if (content.kind === "get" && content.template) {
          const template = content.template;
          setActiveTemplateId(template.id);
          templateNameInput.value = template.name ?? "";
          templateInput.value = template.template ?? "";
          variablesInput.value = JSON.stringify(template.variables ?? [], null, 2);
          valuesInput.value = "{}";
          renderedOutput.hidden = true;
          renderedOutput.textContent = "";
          insertButton.disabled = true;
          renderTemplateLibrary(lastLibraryTemplates);
          setStatus(`Loaded template \"${template.name}\".`);
          loadTemplateVersions().catch((error) => {
            console.error("list_template_versions failed", error);
          });
          return;
        }

        if (content.kind === "save" && content.template?.id) {
          setActiveTemplateId(content.template.id);
          renderTemplateLibrary(lastLibraryTemplates);
          loadTemplateVersions().catch((error) => {
            console.error("list_template_versions failed", error);
          });
          return;
        }

        if (content.kind === "update" && content.template?.id) {
          setActiveTemplateId(content.template.id);
          renderTemplateLibrary(lastLibraryTemplates);
          loadTemplateVersions().catch((error) => {
            console.error("list_template_versions failed", error);
          });
          return;
        }

        if (content.kind === "delete" && content.deleted) {
          resetWorkspace();
          renderTemplateLibrary(lastLibraryTemplates.filter((item) => item.id !== content.id));
          renderVersionHistory([]);
          return;
        }

        if (content.kind === "versions") {
          renderVersionHistory(content.versions ?? []);
          setStatus(
            content.versions?.length
              ? `Version history loaded (${content.versions.length}).`
              : "No versions available yet."
          );
          return;
        }

        if (content.kind === "restore") {
          if (!content.restored) {
            setStatus("Could not restore that version.");
          }
        }
      }

      function rpcNotify(method, params) {
        window.parent.postMessage({ jsonrpc: "2.0", method, params }, "*");
      }

      function rpcRequest(method, params) {
        return new Promise((resolve, reject) => {
          const id = ++rpcId;
          pendingRequests.set(id, { resolve, reject });
          window.parent.postMessage({ jsonrpc: "2.0", id, method, params }, "*");
        });
      }

      async function callTool(name, args) {
        const response = await rpcRequest("tools/call", {
          name,
          arguments: args,
        });
        applyToolResult(response);
        return response;
      }

      async function loadTemplateById(id) {
        setStatus("Loading template...");
        await callTool("get_template", { id });
      }

      async function loadTemplateVersions() {
        if (!activeTemplateId) {
          renderVersionHistory([]);
          return;
        }
        await callTool("list_template_versions", { id: activeTemplateId, limit: 20 });
      }

      async function refreshLibrary(options = {}) {
        const query = options.query ?? "";
        if (query && query.trim()) {
          await callTool("search_templates", { query: query.trim(), limit: 25 });
          return;
        }
        await callTool("list_templates", {});
      }

      window.addEventListener(
        "message",
        (event) => {
          if (event.source !== window.parent) return;

          const message = event.data;
          if (!message || message.jsonrpc !== "2.0") return;

          if (typeof message.id === "number") {
            const request = pendingRequests.get(message.id);
            if (!request) return;
            pendingRequests.delete(message.id);

            if (message.error) {
              request.reject(message.error);
              return;
            }
            request.resolve(message.result);
            return;
          }

          if (message.method === "ui/notifications/tool-result") {
            applyToolResult(message.params);
          }
        },
        { passive: true }
      );

      async function initializeBridge() {
        await rpcRequest("ui/initialize", {
          appInfo: { name: "promptfill-fullscreen", version: "0.2.0" },
          appCapabilities: {},
          protocolVersion: "2026-01-26",
        });
        rpcNotify("ui/notifications/initialized", {});
        await refreshLibrary();
      }

      const bridgeReady = initializeBridge().catch((error) => {
        console.error("Bridge initialization failed:", error);
        setStatus("Unable to initialize widget bridge.");
      });

      renderButton.addEventListener("click", async () => {
        renderButton.disabled = true;
        setStatus("Rendering prompt...");

        try {
          const variables = parseJsonInput("Variables JSON", variablesInput.value, []);
          const values = parseJsonInput("Values JSON", valuesInput.value, {});
          await bridgeReady;
          await callTool("render_prompt", {
            template: templateInput.value,
            variables,
            values,
          });
        } catch (error) {
          console.error("render_prompt failed", error);
          setStatus(error instanceof Error ? error.message : "Could not render. Check your inputs and try again.");
        } finally {
          renderButton.disabled = false;
        }
      });

      insertButton.addEventListener("click", async () => {
        const renderedText = renderedOutput.textContent?.trim();
        if (!renderedText) {
          setStatus("Render a prompt first.");
          return;
        }

        insertButton.disabled = true;
        setStatus("Inserting into chat...");

        try {
          await bridgeReady;
          const result = await rpcRequest("ui/message", {
            role: "user",
            content: [{ type: "text", text: renderedText }],
          });
          if (result?.isError) {
            setStatus("Could not insert into chat. Try again.");
            return;
          }
          setStatus("Inserted into chat.");
        } catch (error) {
          console.error("ui/message failed", error);
          setStatus("Could not insert into chat. Try again.");
        } finally {
          insertButton.disabled = false;
        }
      });

      saveTemplateButton.addEventListener("click", async () => {
        saveTemplateButton.disabled = true;
        setStatus("Saving template...");

        try {
          const variables = parseJsonInput("Variables JSON", variablesInput.value, []);
          await bridgeReady;
          const response = await callTool("save_template", {
            name: templateNameInput.value.trim() || "Untitled template",
            template: templateInput.value,
            variables,
          });

          const savedId = response?.structuredContent?.template?.id;
          if (savedId) {
            setActiveTemplateId(savedId);
            await refreshLibrary({ query: templateSearchInput.value });
          }
          setStatus("Template saved.");
        } catch (error) {
          console.error("save_template failed", error);
          setStatus(error instanceof Error ? error.message : "Could not save template.");
        } finally {
          saveTemplateButton.disabled = false;
        }
      });

      updateTemplateButton.addEventListener("click", async () => {
        if (!activeTemplateId) {
          setStatus("Select or save a template first.");
          return;
        }

        updateTemplateButton.disabled = true;
        setStatus("Updating template...");

        try {
          const variables = parseJsonInput("Variables JSON", variablesInput.value, []);
          await bridgeReady;
          await callTool("update_template", {
            id: activeTemplateId,
            name: templateNameInput.value.trim() || "Untitled template",
            template: templateInput.value,
            variables,
          });
          await refreshLibrary({ query: templateSearchInput.value });
        } catch (error) {
          console.error("update_template failed", error);
          setStatus(error instanceof Error ? error.message : "Could not update template.");
        } finally {
          updateTemplateButton.disabled = false;
        }
      });

      deleteTemplateButton.addEventListener("click", async () => {
        if (!activeTemplateId) {
          setStatus("Select a template first.");
          return;
        }

        deleteTemplateButton.disabled = true;
        setStatus("Deleting template...");

        try {
          await bridgeReady;
          await callTool("delete_template", { id: activeTemplateId });
          await refreshLibrary({ query: templateSearchInput.value });
        } catch (error) {
          console.error("delete_template failed", error);
          setStatus(error instanceof Error ? error.message : "Could not delete template.");
        } finally {
          deleteTemplateButton.disabled = false;
        }
      });

      searchTemplatesButton.addEventListener("click", async () => {
        searchTemplatesButton.disabled = true;
        setStatus("Searching templates...");
        try {
          await bridgeReady;
          await refreshLibrary({ query: templateSearchInput.value });
        } catch (error) {
          console.error("search_templates failed", error);
          setStatus("Could not search templates.");
        } finally {
          searchTemplatesButton.disabled = false;
        }
      });

      listTemplatesButton.addEventListener("click", async () => {
        listTemplatesButton.disabled = true;
        setStatus("Refreshing library...");
        try {
          await bridgeReady;
          await refreshLibrary();
        } catch (error) {
          console.error("list_templates failed", error);
          setStatus("Could not load templates.");
        } finally {
          listTemplatesButton.disabled = false;
        }
      });

      suggestTemplatesButton.addEventListener("click", async () => {
        suggestTemplatesButton.disabled = true;
        setStatus("Loading starter templates...");
        try {
          await bridgeReady;
          const query = templateSearchInput.value.trim();
          await callTool("suggest_templates", {
            query,
            use_case: query && !query.includes(" ") ? query.toLowerCase() : "",
            limit: 12,
          });
        } catch (error) {
          console.error("suggest_templates failed", error);
          setStatus("Could not load starter templates.");
        } finally {
          suggestTemplatesButton.disabled = false;
        }
      });

      clearSelectionButton.addEventListener("click", () => {
        resetWorkspace();
        renderTemplateLibrary(lastLibraryTemplates);
        setStatus("Started a new draft.");
      });

      listVersionsButton.addEventListener("click", async () => {
        if (!activeTemplateId) {
          setStatus("Select a template first.");
          return;
        }
        listVersionsButton.disabled = true;
        setStatus("Loading version history...");
        try {
          await bridgeReady;
          await loadTemplateVersions();
        } catch (error) {
          console.error("list_template_versions failed", error);
          setStatus("Could not load version history.");
        } finally {
          listVersionsButton.disabled = !activeTemplateId;
        }
      });

      renderVersionHistory([]);
    </script>
  </body>
</html>
